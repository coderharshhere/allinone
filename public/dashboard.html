<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AllInOne MP ‚Äì Dashboard</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap');
body { 
  font-family: 'Noto Sans Devanagari', sans-serif; 
  background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
}
.status-badge {
  padding: 4px 10px;
  border-radius: 20px;
  font-weight: 600;
  font-size: 0.85rem;
  display: inline-block;
}
.status-pending { background: #fff8e6; color: #e69500; border: 1px solid #ffd54f; }
.status-complete { background: #e8f5e9; color: #2e7d32; border: 1px solid #81c784; }
.status-reject { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
.action-btn {
  transition: all 0.2s ease;
  width: 32px;
  height: 32px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
}
.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
.action-view { background: #e3f2fd; color: #1976d2; }
.action-delete { background: #ffebee; color: #c62828; }
.action-edit { background: #e8f5e9; color: #2e7d32; }
.table-row:hover {
  background-color: #f8fafc;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.filter-container {
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  padding: 1.25rem;
  margin-bottom: 1.5rem;
}
.stats-card {
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  position: relative;
  overflow: hidden;
}
.stats-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.12);
}
.stats-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 5px;
  height: 100%;
}
.stats-total::before { background: linear-gradient(to bottom, #1e3a8a, #3b82f6); }
.stats-pending::before { background: linear-gradient(to bottom, #b45309, #f59e0b); }
.stats-complete::before { background: linear-gradient(to bottom, #166534, #22c55e); }
.stats-rejected::before { background: linear-gradient(to bottom, #b91c1c, #ef4444); }
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.fade-in {
  animation: fadeIn 0.5s ease forwards;
}
.loading-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid rgba(59, 130, 246, 0.2);
  border-top: 4px solid #3b82f6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 2rem auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.empty-state {
  text-align: center;
  padding: 3rem;
  color: #64748b;
}
.empty-state i {
  font-size: 3.5rem;
  margin-bottom: 1rem;
  opacity: 0.7;
}
.empty-state h3 {
  font-size: 1.5rem;
  margin-bottom: 0.5rem;
  font-weight: 600;
}
.pdf-page {
  background: white;
  padding: 40px;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  position: relative;
  font-family: 'Noto Sans Devanagari', 'Arial Unicode MS', sans-serif !important;
  width: 210mm;
  min-height: 297mm;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
.pdf-header {
  text-align: center;
  margin-bottom: 30px;
  border-bottom: 3px solid #1e3a8a;
  padding-bottom: 15px;
}
.pdf-logo {
  height: 60px;
  margin-bottom: 10px;
}
.pdf-title {
  font-size: 24px;
  font-weight: 700;
  color: #1e3a8a;
  margin: 5px 0;
}
.pdf-subtitle {
  color: #4b5563;
  font-size: 16px;
}
.pdf-app-no {
  background: #dbeafe;
  display: inline-block;
  padding: 5px 15px;
  border-radius: 20px;
  font-weight: 600;
  margin: 10px 0;
}
.pdf-details-table {
  width: 100%;
  border-collapse: collapse;
  margin: 25px 0;
}
.pdf-details-table th {
  background-color: #1e3a8a;
  color: white;
  text-align: left;
  padding: 12px 15px;
}
.pdf-details-table td {
  padding: 10px 15px;
  border-bottom: 1px solid #e2e8f0;
}
.pdf-details-table tr:nth-child(even) {
  background-color: #f8fafc;
}
.pdf-footer {
  margin-top: 30px;
  text-align: center;
  font-size: 14px;
  color: #64748b;
  border-top: 1px solid #e2e8f0;
  padding-top: 15px;
}
.pdf-qr-container {
  position: absolute;
  top: 30px;
  right: 30px;
  border: 1px solid #cbd5e1;
  padding: 8px;
  background: white;
  border-radius: 8px;
}
@page {
  size: A4;
  margin: 20mm;
}
@media print {
  body {
    background: white;
    padding: 0;
  }
  .pdf-page {
    box-shadow: none;
    border: none;
    padding: 0;
  }
  .no-print {
    display: none;
  }
}
</style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">

<!-- HEADER -->
<header class="bg-gradient-to-r from-blue-900 to-blue-700 text-white shadow-lg sticky top-0 z-50">
  <div class="container mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center">
    <div class="flex items-center gap-3 mb-3 md:mb-0">
      <div class="bg-white p-1.5 rounded-lg">
        <div class="bg-blue-900 w-10 h-10 md:w-12 md:h-12 rounded flex items-center justify-center">
          <span class="text-white font-bold text-xl md:text-2xl">MP</span>
        </div>
      </div>
      <div>
        <h1 class="text-xl md:text-2xl font-bold flex items-center">
          <i class="fas fa-landmark mr-2"></i>
          AllInOne-MP
        </h1>
        <p class="text-xs md:text-sm opacity-90">‡§Æ‡§ß‡•ç‡§Ø ‡§™‡•ç‡§∞‡§¶‡•á‡§∂ ‡§∏‡§∞‡§ï‡§æ‡§∞ - ‡§è‡§ï ‡§µ‡§ø‡§Ç‡§°‡•ã ‡§∏‡§Æ‡§æ‡§ß‡§æ‡§®</p>
      </div>
    </div>

    <div class="flex flex-col md:flex-row items-center gap-4">
      <div class="text-center md:text-right">
        <p class="text-xs opacity-90 uppercase flex items-center justify-center md:justify-end">
          <i class="fas fa-headset mr-1"></i> ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞
        </p>
        <p class="font-bold text-lg flex items-center justify-center md:justify-end">
          <i class="fas fa-phone-alt mr-2 text-yellow-300"></i> 1800-123-4567
        </p>
      </div>
      
      <div class="relative group">
        <div class="flex items-center cursor-pointer p-2 hover:bg-white/10 rounded-full transition" id="profileButton">
          <div class="bg-yellow-300 text-blue-900 font-bold w-9 h-9 rounded-full flex items-center justify-center text-lg">
            <i class="fas fa-user"></i>
          </div>
          <div class="ml-2 hidden md:block">
            <p class="font-bold text-sm" id="adminName">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</p>
            <p class="text-xs opacity-90" id="adminEmail">-</p>
          </div>
          <i class="fas fa-chevron-down ml-1 text-xs hidden md:block"></i>
        </div>
        
        <div class="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-xl py-2 z-50 hidden" id="profileDropdown">
          <a href="#" class="flex items-center px-4 py-2 text-gray-800 hover:bg-blue-50 transition">
            <i class="fas fa-user-circle mr-3 text-blue-600"></i> ‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤
          </a>
          <a href="#" class="flex items-center px-4 py-2 text-gray-800 hover:bg-blue-50 transition">
            <i class="fas fa-cog mr-3 text-blue-600"></i> ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏
          </a>
          <div class="border-t my-1"></div>
          <a href="#" onclick="logout()" class="flex items-center px-4 py-2 text-red-600 hover:bg-red-50 transition">
            <i class="fas fa-sign-out-alt mr-3"></i> ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü
          </a>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- MAIN CONTENT -->
<main class="flex-1 container mx-auto px-4 py-6">
  <!-- Search and Filters -->
  <div class="filter-container fade-in">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
      <div class="md:col-span-1">
        <div class="relative">
          <input id="searchInput" placeholder="‡§®‡§æ‡§Æ ‡§Ø‡§æ ID ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç..." 
            class="border border-gray-300 p-3 w-full pl-10 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
          <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
        </div>
      </div>
      
      <div>
        <select id="serviceFilter" class="border border-gray-300 p-3 w-full rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
          <option value="">‡§∏‡§≠‡•Ä ‡§∏‡•á‡§µ‡§æ‡§è‡§Ç</option>
          <option value="samagra">‡§∏‡§Æ‡§ó‡•ç‡§∞ ‡§Ü‡§à‡§°‡•Ä</option>
          <option value="ekyc">‡§à-‡§ï‡•á‡§µ‡§æ‡§à‡§∏‡•Ä</option>
          <option value="mpbhoj">‡§è‡§Æ‡§™‡•Ä ‡§≠‡•ã‡§ú ‡§Ø‡•ã‡§ú‡§®‡§æ</option>
          <option value="scholarship">‡§õ‡§æ‡§§‡•ç‡§∞‡§µ‡•É‡§§‡•ç‡§§‡§ø</option>
          <option value="pension">‡§™‡•á‡§Ç‡§∂‡§®</option>
        </select>
      </div>
      
      <div>
        <select id="statusFilter" class="border border-gray-300 p-3 w-full rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
          <option value="">‡§∏‡§≠‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø‡§Ø‡§æ‡§Ç</option>
          <option value="pending">‡§≤‡§Ç‡§¨‡§ø‡§§</option>
          <option value="complete">‡§™‡•Ç‡§∞‡•ç‡§£</option>
          <option value="reject">‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§</option>
        </select>
      </div>
      
      <div class="flex items-end">
        <button id="clearFilters" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg w-full transition flex items-center justify-center">
          <i class="fas fa-redo mr-2"></i> ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
        </button>
      </div>
    </div>
    
    <div class="flex flex-col sm:flex-row justify-between items-center gap-3 pt-2 border-t border-gray-100">
      <div class="flex flex-wrap gap-2">
        <button id="exportCSV" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center">
          <i class="fas fa-file-csv mr-2"></i> CSV ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§
        </button>
        <button id="printView" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center">
          <i class="fas fa-print mr-2"></i> ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§µ‡•ç‡§Ø‡•Ç
        </button>
      </div>
      
      <div class="text-sm text-gray-600 flex items-center">
        <i class="fas fa-info-circle mr-2 text-blue-500"></i>
        <span>‡§ï‡•Å‡§≤ ‡§Ü‡§µ‡•á‡§¶‡§®: <span id="totalApplications" class="font-bold text-blue-700">0</span></span>
      </div>
    </div>
  </div>
  
  <!-- Statistics Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 fade-in">
    <div class="stats-card stats-total bg-white p-6">
      <div class="flex items-center">
        <div class="bg-blue-100 p-3 rounded-xl mr-4">
          <i class="fas fa-file-alt text-blue-600 text-2xl"></i>
        </div>
        <div>
          <p class="text-gray-500 text-sm font-medium">‡§ï‡•Å‡§≤ ‡§Ü‡§µ‡•á‡§¶‡§®</p>
          <p class="text-2xl font-bold text-gray-800 mt-1" id="statTotal">0</p>
        </div>
      </div>
    </div>
    
    <div class="stats-card stats-pending bg-white p-6">
      <div class="flex items-center">
        <div class="bg-amber-100 p-3 rounded-xl mr-4">
          <i class="fas fa-clock text-amber-500 text-2xl"></i>
        </div>
        <div>
          <p class="text-gray-500 text-sm font-medium">‡§≤‡§Ç‡§¨‡§ø‡§§</p>
          <p class="text-2xl font-bold text-gray-800 mt-1" id="statPending">0</p>
        </div>
      </div>
    </div>
    
    <div class="stats-card stats-complete bg-white p-6">
      <div class="flex items-center">
        <div class="bg-green-100 p-3 rounded-xl mr-4">
          <i class="fas fa-check-circle text-green-600 text-2xl"></i>
        </div>
        <div>
          <p class="text-gray-500 text-sm font-medium">‡§™‡•Ç‡§∞‡•ç‡§£</p>
          <p class="text-2xl font-bold text-gray-800 mt-1" id="statComplete">0</p>
        </div>
      </div>
    </div>
    
    <div class="stats-card stats-rejected bg-white p-6">
      <div class="flex items-center">
        <div class="bg-red-100 p-3 rounded-xl mr-4">
          <i class="fas fa-times-circle text-red-600 text-2xl"></i>
        </div>
        <div>
          <p class="text-gray-500 text-sm font-medium">‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§</p>
          <p class="text-2xl font-bold text-gray-800 mt-1" id="statRejected">0</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Applications Table -->
  <div class="bg-white rounded-2xl shadow-lg overflow-hidden fade-in">
    <div class="p-4 md:p-6 border-b border-gray-100 flex flex-col md:flex-row justify-between items-center">
      <h2 class="text-xl md:text-2xl font-bold text-gray-800 flex items-center">
        <i class="fas fa-list mr-3 text-blue-600"></i>
        ‡§Ü‡§µ‡•á‡§¶‡§® ‡§∏‡•Ç‡§ö‡•Ä
      </h2>
      <div class="mt-3 md:mt-0 flex flex-wrap gap-2">
        <div class="relative">
          <input type="date" id="dateFrom" class="border border-gray-300 p-2 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <label class="absolute -top-2 left-2 bg-white px-1 text-xs text-gray-500">‡§∏‡•á</label>
        </div>
        <div class="relative">
          <input type="date" id="dateTo" class="border border-gray-300 p-2 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <label class="absolute -top-2 left-2 bg-white px-1 text-xs text-gray-500">‡§§‡§ï</label>
        </div>
      </div>
    </div>
    
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-blue-800 text-white">
          <tr>
            <th class="p-4 text-left font-medium">‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï</th>
            <th class="p-4 text-left font-medium">‡§®‡§æ‡§Æ</th>
            <th class="p-4 text-left font-medium">‡§∏‡•á‡§µ‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</th>
            <th class="p-4 text-left font-medium hidden md:table-cell">‡§∏‡§Æ‡§ó‡•ç‡§∞ / ‡§∏‡§¶‡§∏‡•ç‡§Ø ID</th>
            <th class="p-4 text-left font-medium hidden sm:table-cell">‡§§‡§æ‡§∞‡•Ä‡§ñ</th>
            <th class="p-4 text-left font-medium">‡§∏‡•ç‡§•‡§ø‡§§‡§ø</th>
            <th class="p-4 text-left font-medium">‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à</th>
          </tr>
        </thead>
        <tbody id="dataTable">
          <!-- Loading state -->
          <tr>
            <td colspan="7" class="p-8 text-center">
              <div class="loading-spinner"></div>
              <p class="mt-4 text-gray-600 font-medium">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <div id="emptyState" class="empty-state hidden">
      <i class="fas fa-file-search text-blue-300"></i>
      <h3>‡§ï‡•ã‡§à ‡§Ü‡§µ‡•á‡§¶‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</h3>
      <p class="mt-2">‡§Ü‡§™‡§ï‡•á ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§Æ‡§æ‡§®‡§¶‡§Ç‡§°‡•ã‡§Ç ‡§∏‡•á ‡§Æ‡•á‡§≤ ‡§ñ‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§ï‡•ã‡§à ‡§Ü‡§µ‡•á‡§¶‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</p>
      <button id="resetFilters" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center mx-auto">
        <i class="fas fa-filter mr-2"></i> ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
      </button>
    </div>
    
    <div class="p-4 border-t border-gray-100 flex flex-col sm:flex-row justify-between items-center">
      <p class="text-gray-500 text-sm mb-2 sm:mb-0">‡§™‡•ç‡§∞‡§§‡§ø ‡§™‡•É‡§∑‡•ç‡§† ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç: 
        <select class="border border-gray-300 rounded px-2 py-1 ml-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <option>10</option>
          <option>25</option>
          <option selected>50</option>
          <option>100</option>
        </select>
      </p>
      <div class="flex items-center space-x-2">
        <button class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition">‡§™‡§ø‡§õ‡§≤‡§æ</button>
        <span class="font-medium">1 ‡§∏‡•á 10 ‡§ï‡§æ 50</span>
        <button class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition">‡§Ö‡§ó‡§≤‡§æ</button>
      </div>
    </div>
  </div>
</main>

<!-- DETAILS MODAL -->
<div id="detailModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4">
  <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
    <div class="bg-gradient-to-r from-blue-800 to-blue-600 text-white p-5 flex justify-between items-center rounded-t-2xl">
      <h2 class="font-bold text-xl flex items-center">
        <i class="fas fa-file-invoice mr-3"></i>
        ‡§Ü‡§µ‡•á‡§¶‡§® ‡§µ‡§ø‡§µ‡§∞‡§£
      </h2>
      <div class="flex space-x-3">
        <button onclick="printApplication()" class="bg-white text-blue-800 px-4 py-2 rounded-lg font-medium hover:bg-blue-50 transition flex items-center">
          <i class="fas fa-print mr-2"></i> ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü
        </button>
        <button onclick="downloadPDF()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition flex items-center">
          <i class="fas fa-file-pdf mr-2"></i> PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°
        </button>
        <button onclick="closeDetails()" class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center hover:bg-white/30 transition">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <div id="detailBody" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-5 overflow-y-auto flex-1">
      <!-- Content will be dynamically inserted here -->
    </div>

    <div class="p-5 bg-gray-50 border-t border-gray-100 rounded-b-2xl">
      <div class="flex flex-col sm:flex-row justify-between items-center gap-3">
        <div class="flex items-center text-sm text-gray-600">
          <i class="fas fa-info-circle mr-2 text-blue-500"></i>
          <span>‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï: <span id="modalApplicationNo" class="font-bold text-blue-700">AIO-XXXXXXXX</span></span>
        </div>
        <div class="flex space-x-3">
          <button onclick="updateStatus('pending')" class="bg-amber-100 text-amber-800 px-4 py-2 rounded-lg font-medium hover:bg-amber-200 transition flex items-center">
            <i class="fas fa-clock mr-2"></i> ‡§≤‡§Ç‡§¨‡§ø‡§§ ‡§∞‡§ñ‡•á‡§Ç
          </button>
          <button onclick="updateStatus('complete')" class="bg-green-100 text-green-800 px-4 py-2 rounded-lg font-medium hover:bg-green-200 transition flex items-center">
            <i class="fas fa-check mr-2"></i> ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ï‡§∞‡•á‡§Ç
          </button>
          <button onclick="updateStatus('reject')" class="bg-red-100 text-red-800 px-4 py-2 rounded-lg font-medium hover:bg-red-200 transition flex items-center">
            <i class="fas fa-times mr-2"></i> ‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PDF TEMPLATE -->
<div id="pdfContent" style="visibility:hidden; position:absolute; left:-9999px;">
  <div class="pdf-page">
    <div class="pdf-header">
      <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px;">
        <div style="background: #1e3a8a; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px;">
          MP
        </div>
        <div style="text-align: left;">
          <div style="font-size: 18px; font-weight: bold; color: #1e3a8a;">‡§Æ‡§ß‡•ç‡§Ø ‡§™‡•ç‡§∞‡§¶‡•á‡§∂ ‡§∏‡§∞‡§ï‡§æ‡§∞</div>
          <div style="font-size: 14px; color: #4b5563;">Government of Madhya Pradesh</div>
        </div>
      </div>
      <h1 class="pdf-title">AllInOne MP ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤ - ‡§Ü‡§µ‡•á‡§¶‡§® ‡§µ‡§ø‡§µ‡§∞‡§£</h1>
      <p class="pdf-subtitle">‡§∏‡§≠‡•Ä ‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§∏‡•á‡§µ‡§æ‡§ì‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï‡§≤ ‡§ñ‡§ø‡§°‡§º‡§ï‡•Ä ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä</p>
      <div class="pdf-app-no">‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï: <span id="pdfApplicationNo">AIO-XXXXXXXX</span></div>
    </div>
    
    <div class="pdf-qr-container" id="pdfQR"></div>
    
    <table class="pdf-details-table">
      <thead>
        <tr>
          <th>‡§µ‡§ø‡§µ‡§∞‡§£</th>
          <th>‡§Æ‡§æ‡§®</th>
        </tr>
      </thead>
      <tbody id="pdfDetailsTable">
        <!-- Content will be dynamically inserted here -->
      </tbody>
    </table>
    
    <div class="pdf-footer">
      <p>‡§Ø‡§π ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§°‡§ø‡§ú‡§ø‡§ü‡§≤ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à ‡§î‡§∞ ‡§á‡§∏ ‡§™‡§∞ ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</p>
      <p class="mt-1">‡§™‡•ã‡§∞‡•ç‡§ü‡§≤: allinone.mp.gov.in | ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ: 1800-123-4567</p>
      <p class="mt-2">‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§§‡§ø‡§•‡§ø: <span id="pdfDownloadDate"></span></p>
    </div>
  </div>
</div>

<!-- FOOTER -->
<footer class="bg-gray-900 text-gray-300 py-8 px-4 mt-auto">
  <div class="container mx-auto text-center">
    <div class="flex justify-center space-x-6 mb-4">
      <a href="#" class="hover:text-white transition flex items-center">
        <i class="fab fa-facebook-f mr-2"></i> Facebook
      </a>
      <a href="#" class="hover:text-white transition flex items-center">
        <i class="fab fa-twitter mr-2"></i> Twitter
      </a>
      <a href="#" class="hover:text-white transition flex items-center">
        <i class="fab fa-youtube mr-2"></i> YouTube
      </a>
      <a href="#" class="hover:text-white transition flex items-center">
        <i class="fas fa-globe mr-2"></i> ‡§Ü‡§ß‡§ø‡§ï‡§æ‡§∞‡§ø‡§ï ‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü
      </a>
    </div>
    <p class="font-medium">¬© 2026 AllInOne MP | ‡§Æ‡§ß‡•ç‡§Ø ‡§™‡•ç‡§∞‡§¶‡•á‡§∂ ‡§∏‡§∞‡§ï‡§æ‡§∞ ‡§∏‡•á‡§µ‡§æ ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤</p>
    <p class="text-xs mt-2 text-gray-400">‡§∏‡•Ç‡§ö‡§®‡§æ ‡§™‡•ç‡§∞‡•å‡§¶‡•ç‡§Ø‡•ã‡§ó‡§ø‡§ï‡•Ä ‡§µ‡§ø‡§≠‡§æ‡§ó, ‡§Æ‡§ß‡•ç‡§Ø ‡§™‡•ç‡§∞‡§¶‡•á‡§∂ ‡§∏‡§∞‡§ï‡§æ‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§ø‡§§‡•§</p>
    <div class="mt-4 flex justify-center space-x-4">
      <span class="bg-blue-900 text-white text-xs px-3 py-1 rounded-full">‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§</span>
      <span class="bg-green-800 text-white text-xs px-3 py-1 rounded-full">‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§ø‡§§</span>
      <span class="bg-amber-700 text-white text-xs px-3 py-1 rounded-full">‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä</span>
    </div>
  </div>
</footer>

<script type="module">
/* ===== IMPORTS ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc } 
  from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } 
  from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

/* ===== CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyA-iZvVroV-H6aRs7X-mlnt_ra3_vnaNzg",
  authDomain: "allinone-aa89.firebaseapp.com",
  projectId: "allinone-aa89"
};

/* ===== INIT ===== */
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;

/* ===== AUTH GUARD ===== */
onAuthStateChanged(auth, user => {
  if (!user) {
    window.location.href = "login.html";
  } else {
    // Set current user
    currentUser = user;
    
    // Update admin details in header
    document.getElementById('adminName').textContent = user.displayName || '‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä ‡§ú‡•Ä';
    document.getElementById('adminEmail').textContent = user.email || 'admin@mp.gov.in';
    
    // Load data
    loadData();
    setupEventListeners();
  }
});

/* ===== DATA ===== */
let allApplications = [];
let currentFilters = {
  search: '',
  service: '',
  status: '',
  dateFrom: '',
  dateTo: ''
};

/* ===== SETUP EVENT LISTENERS ===== */
function setupEventListeners() {
  // Profile dropdown toggle
  document.getElementById('profileButton').addEventListener('click', () => {
    const dropdown = document.getElementById('profileDropdown');
    dropdown.classList.toggle('hidden');
  });
  
  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    const dropdown = document.getElementById('profileDropdown');
    const profileButton = document.getElementById('profileButton');
    if (!dropdown.contains(e.target) && !profileButton.contains(e.target)) {
      dropdown.classList.add('hidden');
    }
  });
  
  // Search input
  document.getElementById('searchInput').addEventListener('input', (e) => {
    currentFilters.search = e.target.value.toLowerCase();
    applyFilters();
  });
  
  // Service filter
  document.getElementById('serviceFilter').addEventListener('change', (e) => {
    currentFilters.service = e.target.value;
    applyFilters();
  });
  
  // Status filter
  document.getElementById('statusFilter').addEventListener('change', (e) => {
    currentFilters.status = e.target.value;
    applyFilters();
  });
  
  // Date filters
  document.getElementById('dateFrom').addEventListener('change', (e) => {
    currentFilters.dateFrom = e.target.value;
    applyFilters();
  });
  
  document.getElementById('dateTo').addEventListener('change', (e) => {
    currentFilters.dateTo = e.target.value;
    applyFilters();
  });
  
  // Clear filters button
  document.getElementById('clearFilters').addEventListener('click', () => {
    document.getElementById('searchInput').value = '';
    document.getElementById('serviceFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    
    currentFilters = {
      search: '',
      service: '',
      status: '',
      dateFrom: '',
      dateTo: ''
    };
    
    render(allApplications);
    updateStats(allApplications);
  });
  
  // Reset filters from empty state
  document.getElementById('resetFilters').addEventListener('click', () => {
    document.getElementById('searchInput').value = '';
    document.getElementById('serviceFilter').value = '';
    document.getElementById('statusFilter').value = '';
    currentFilters.search = '';
    currentFilters.service = '';
    currentFilters.status = '';
    render(allApplications);
    updateStats(allApplications);
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('dataTable').classList.remove('hidden');
  });
  
  // Export CSV
  document.getElementById('exportCSV').addEventListener('click', exportToCSV);
  
  // Print View
  document.getElementById('printView').addEventListener('click', () => {
    window.print();
  });
}

/* ===== LOAD DATA ===== */
function loadData() {
  listen("applications");
  listen("samagra_ekyc_requests");
  listen("mpbhojApplications");
}

function listen(col) {
  onSnapshot(collection(db, col), snap => {
    allApplications = allApplications.filter(i => i._collection !== col);
    const data = snap.docs.map(d => ({
      id: d.id,
      _collection: col,
      ...d.data()
    }));
    allApplications = [...allApplications, ...data];
    render(allApplications);
    updateStats(allApplications);
  }, error => {
    console.error("Error loading data: ", error);
    // Show error state
    document.getElementById('dataTable').innerHTML = `
      <tr>
        <td colspan="7" class="p-8 text-center">
          <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-3"></i>
          <p class="mt-2 text-red-600 font-medium">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø</p>
          <p class="text-gray-500 mt-1">‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç ‡§Ø‡§æ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§</p>
        </td>
      </tr>
    `;
  });
}

/* ===== APPLY FILTERS ===== */
function applyFilters() {
  let filteredData = [...allApplications];
  
  // Search filter
  if (currentFilters.search) {
    filteredData = filteredData.filter(app => {
      const name = (app.studentName || app.applicantName || '').toLowerCase();
      const id = (app.memberId || '').toLowerCase();
      return name.includes(currentFilters.search) || id.includes(currentFilters.search);
    });
  }
  
  // Service filter
  if (currentFilters.service) {
    filteredData = filteredData.filter(app => {
      const service = getServiceName(app).toLowerCase();
      return service.includes(currentFilters.service);
    });
  }
  
  // Status filter
  if (currentFilters.status) {
    filteredData = filteredData.filter(app => app.status === currentFilters.status);
  }
  
  // Date filters
  if (currentFilters.dateFrom || currentFilters.dateTo) {
    filteredData = filteredData.filter(app => {
      if (!app.createdAt) return false;
      
      const appDate = new Date(app.createdAt.toDate());
      const fromDate = currentFilters.dateFrom ? new Date(currentFilters.dateFrom) : null;
      const toDate = currentFilters.dateTo ? new Date(currentFilters.dateTo) : null;
      
      if (fromDate && appDate < fromDate) return false;
      if (toDate && appDate > toDate) return false;
      
      return true;
    });
  }
  
  render(filteredData);
  updateStats(filteredData);
}

/* ===== RENDER TABLE ===== */
function render(data) {
  const tableBody = document.getElementById("dataTable");
  const emptyState = document.getElementById("emptyState");
  
  // Update total applications count
  document.getElementById("totalApplications").textContent = allApplications.length;
  
  // Show/hide empty state
  if (data.length === 0) {
    tableBody.classList.add('hidden');
    emptyState.classList.remove('hidden');
    return;
  } else {
    tableBody.classList.remove('hidden');
    emptyState.classList.add('hidden');
  }
  
  // Create table rows
  let rows = '';
  data.forEach((i, index) => {
    const appNo = `AIO-${i.id.substring(0, 8).toUpperCase()}`;
    const serviceName = getServiceName(i);
    const statusClass = i.status === 'complete' ? 'status-complete' : 
                        i.status === 'reject' ? 'status-reject' : 'status-pending';
    const statusText = i.status === 'complete' ? '‡§™‡•Ç‡§∞‡•ç‡§£' : 
                       i.status === 'reject' ? '‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§' : '‡§≤‡§Ç‡§¨‡§ø‡§§';
    
    rows += `
      <tr class="table-row border-b border-gray-100 hover:bg-blue-50/50 transition-colors">
        <td class="p-4 font-mono font-medium text-blue-700">${appNo}</td>
        <td class="p-4 font-bold text-gray-800">${i.studentName || i.applicantName || "-"}</td>
        <td class="p-4">
          <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">${serviceName}</span>
        </td>
        <td class="p-4 hidden md:table-cell font-mono">${i.memberId || "-"}</td>
        <td class="p-4 hidden sm:table-cell">${formatDate(i.createdAt)}</td>
        <td class="p-4">
          <span class="status-badge ${statusClass}">${statusText}</span>
        </td>
        <td class="p-4">
          <div class="flex space-x-2">
            <button onclick="openDetails('${i.id}')" class="action-btn action-view" title="‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡•á‡§ñ‡•á‡§Ç">
              <i class="fas fa-eye"></i>
            </button>
            <button onclick="del('${i.id}')" class="action-btn action-delete" title="‡§π‡§ü‡§æ‡§è‡§Ç">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        </td>
      </tr>
    `;
  });
  
  tableBody.innerHTML = rows;
}

/* ===== UPDATE STATS ===== */
function updateStats(data) {
  document.getElementById('statTotal').textContent = data.length;
  
  const pending = data.filter(a => a.status === 'pending').length;
  const complete = data.filter(a => a.status === 'complete').length;
  const rejected = data.filter(a => a.status === 'reject').length;
  
  document.getElementById('statPending').textContent = pending;
  document.getElementById('statComplete').textContent = complete;
  document.getElementById('statRejected').textContent = rejected;
}

/* ===== HELPERS ===== */
function getServiceName(app) {
  return app.serviceType || app.formType || app.serviceName || app.service || app.applicationType || '‡§Ö‡§®‡•ç‡§Ø';
}

function formatDate(ts) {
  if (!ts) return "-";
  return ts.toDate().toLocaleDateString("hi-IN", {
    day: '2-digit',
    month: 'short',
    year: 'numeric'
  });
}

function formatLabel(key) {
  return key
    .replace(/_/g, " ")
    .replace(/([A-Z])/g, " $1")
    .replace(/^./, s => s.toUpperCase())
    .replace('Id', 'ID');
}

/* ===== ACTIONS ===== */
window.del = async (id) => {
  if (!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ø‡§π ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§™‡•Ç‡§∞‡•ç‡§µ‡§µ‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä‡•§")) {
    return;
  }
  
  const item = allApplications.find(x => x.id === id);
  if (!item) return;
  
  try {
    await deleteDoc(doc(db, item._collection, id));
    // Success message would be shown here in a real app
  } catch (error) {
    console.error("Error deleting document: ", error);
    alert("‡§Ü‡§µ‡•á‡§¶‡§® ‡§π‡§ü‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§");
  }
};

window.updateStatus = async (status) => {
  const appNoElement = document.getElementById('modalApplicationNo');
  if (!appNoElement) return;
  
  const appNo = appNoElement.textContent;
  // Extract the actual ID from the application number
  const item = allApplications.find(x => appNo.includes(x.id.substring(0,8).toUpperCase()));
  
  if (!item) {
    alert("‡§Ü‡§µ‡•á‡§¶‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§");
    return;
  }
  
  try {
    await updateDoc(doc(db, item._collection, item.id), { status });
    // Close modal after update
    closeDetails();
    // Show success message
    const statusText = status === 'complete' ? '‡§™‡•Ç‡§∞‡•ç‡§£' : status === 'reject' ? '‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§' : '‡§≤‡§Ç‡§¨‡§ø‡§§';
    alert(`‡§Ü‡§µ‡•á‡§¶‡§® ‡§∏‡•ç‡§•‡§ø‡§§‡§ø "${statusText}" ‡§Æ‡•á‡§Ç ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞ ‡§¶‡•Ä ‡§ó‡§à ‡§π‡•à‡•§`);
  } catch (error) {
    console.error("Error updating status: ", error);
    alert("‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§");
  }
};

window.logout = () => {
  if (confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) {
    signOut(auth).then(() => {
      window.location.href = "login.html";
    });
  }
};

/* ===== DETAILS MODAL ===== */
window.openDetails = (id) => {
  const item = allApplications.find(a => a.id === id);
  if (!item) return;

  // RESTORED ORIGINAL APPLICATION NUMBER FORMAT for tracking consistency
  const appNo = `AIO-${item.id.substring(0,8).toUpperCase()}`;
  
  // Store ID in dataset for PDF generation
  const appNoElement = document.getElementById("modalApplicationNo");
  appNoElement.textContent = appNo;
  appNoElement.dataset.appId = item.id;
  
  // Populate modal details
  const detailBody = document.getElementById("detailBody");
  let detailsHTML = '';
  
  // Organize fields into sections
  const personalInfo = ['applicantName', 'studentName', 'fatherName', 'motherName', 'dob', 'gender', 'mobileNumber', 'email', 'aadhaarNumber'];
  const addressInfo = ['address', 'village', 'tehsil', 'district', 'pincode', 'state'];
  const applicationInfo = ['memberId', 'applicationType', 'serviceType', 'formType', 'serviceName', 'status', 'createdAt', 'updatedAt'];
  
  // Personal Information section
  detailsHTML += `<div class="col-span-full"><h3 class="font-bold text-lg text-blue-800 mb-3 pb-2 border-b border-blue-100">‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</h3></div>`;
  personalInfo.forEach(key => {
    if (item.hasOwnProperty(key) && item[key]) {
      detailsHTML += createDetailRow(key, item[key]);
    }
  });
  
  // Address section
  detailsHTML += `<div class="col-span-full"><h3 class="font-bold text-lg text-blue-800 mt-4 mb-3 pb-2 border-b border-blue-100">‡§™‡§§‡§æ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</h3></div>`;
  addressInfo.forEach(key => {
    if (item.hasOwnProperty(key) && item[key]) {
      detailsHTML += createDetailRow(key, item[key]);
    }
  });
  
  // Application details section
  detailsHTML += `<div class="col-span-full"><h3 class="font-bold text-lg text-blue-800 mt-4 mb-3 pb-2 border-b border-blue-100">‡§Ü‡§µ‡•á‡§¶‡§® ‡§µ‡§ø‡§µ‡§∞‡§£</h3></div>`;
  applicationInfo.forEach(key => {
    if (item.hasOwnProperty(key) && item[key]) {
      let value = item[key];
      if (key === 'createdAt' && value) {
        value = formatDate(value);
      }
      if (key === 'updatedAt' && value) {
        value = formatDate(value);
      }
      if (key === 'status') {
        const statusClass = value === 'complete' ? 'status-complete' : 
                            value === 'reject' ? 'status-reject' : 'status-pending';
        const statusText = value === 'complete' ? '‡§™‡•Ç‡§∞‡•ç‡§£' : 
                           value === 'reject' ? '‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§' : '‡§≤‡§Ç‡§¨‡§ø‡§§';
        value = `<span class="status-badge ${statusClass}">${statusText}</span>`;
      }
      detailsHTML += createDetailRow(key, value);
    }
  });
  
  detailBody.innerHTML = detailsHTML;
  
  // Show modal
  document.getElementById("detailModal").classList.remove("hidden");
  document.getElementById("detailModal").classList.add("flex");
  
  // Prepare PDF content
  preparePDFContent(item, appNo);
};

function createDetailRow(key, value) {
  return `
    <div class="bg-blue-50 p-3 rounded-lg">
      <div class="text-xs text-blue-700 font-medium">${formatLabel(key)}</div>
      <div class="font-semibold text-gray-800 mt-1">${value || "-"}</div>
    </div>
  `;
}

window.closeDetails = () => {
  document.getElementById("detailModal").classList.add("hidden");
};

/* ===== PDF GENERATION - FIXED ===== */
function preparePDFContent(item, appNo) {
  // Set application number - RESTORED ORIGINAL FORMAT for tracking consistency
  const originalAppNo = `AIO-${item.id.substring(0,8).toUpperCase()}`;
  document.getElementById("pdfApplicationNo").textContent = originalAppNo;
  
  // Set download date
  const today = new Date().toLocaleDateString("hi-IN", {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
  document.getElementById("pdfDownloadDate").textContent = today;
  
  // Clear QR container
  const qrContainer = document.getElementById("pdfQR");
  qrContainer.innerHTML = "";
  
  // Create QR code with application details
  const qrData = `Application: ${originalAppNo}\nName: ${item.applicantName || item.studentName || ""}\nService: ${getServiceName(item)}\nDate: ${today}`;
  
  // Generate QR and convert to image for PDF compatibility
const qr = new QRCode(qrContainer, {
  text: qrData,
  width: 120,
  height: 120,
  correctLevel: QRCode.CorrectLevel.H
});

// üî• canvas ‚Üí image conversion (CRITICAL)
setTimeout(() => {
  const canvas = qrContainer.querySelector("canvas");
  if (canvas) {
    const img = document.createElement("img");
    img.src = canvas.toDataURL("image/png");
    img.style.width = "120px";
    img.style.height = "120px";
    qrContainer.innerHTML = "";
    qrContainer.appendChild(img);
  }
}, 300);

  
  // Generate table content for PDF
  const pdfTableBody = document.getElementById("pdfDetailsTable");
  let tableRows = '';
  
  // Define field order for better presentation
  const fieldOrder = [
    'applicantName', 'studentName', 'fatherName', 'motherName', 
    'dob', 'gender', 'mobileNumber', 'email', 'aadhaarNumber',
    'address', 'village', 'tehsil', 'district', 'pincode', 'state',
    'memberId', 'applicationType', 'serviceType', 'formType', 
    'serviceName', 'status', 'createdAt', 'updatedAt'
  ];
  
  // Add fields in order with proper formatting
  fieldOrder.forEach(key => {
    if (item.hasOwnProperty(key) && item[key]) {
      let displayValue = item[key];
      
      // Format dates
      if ((key === 'createdAt' || key === 'updatedAt') && item[key].toDate) {
        displayValue = item[key].toDate().toLocaleDateString("hi-IN", {
          day: 'numeric',
          month: 'long',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }
      
      // Format status
      if (key === 'status') {
        displayValue = item[key] === 'complete' ? '‡§™‡•Ç‡§∞‡•ç‡§£' : 
                       item[key] === 'reject' ? '‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§' : '‡§≤‡§Ç‡§¨‡§ø‡§§';
      }
      
      // Format gender
      if (key === 'gender') {
        displayValue = item[key] === 'male' ? '‡§™‡•Å‡§∞‡•Å‡§∑' : 
                       item[key] === 'female' ? '‡§Æ‡§π‡§ø‡§≤‡§æ' : 
                       item[key] === 'other' ? '‡§Ö‡§®‡•ç‡§Ø' : item[key];
      }
      
      tableRows += `
        <tr>
          <td style="font-weight: bold; background-color: #f8fafc; padding: 10px 15px;">${formatLabel(key)}</td>
          <td style="padding: 10px 15px;">${displayValue || "-"}</td>
        </tr>
      `;
    }
  });
  
  // Add remaining fields
  Object.keys(item).forEach(key => {
    if (!fieldOrder.includes(key) && !['_collection', 'id'].includes(key) && item[key]) {
      let displayValue = item[key];
      
      if ((key === 'createdAt' || key === 'updatedAt') && item[key].toDate) {
        displayValue = item[key].toDate().toLocaleDateString("hi-IN", {
          day: 'numeric',
          month: 'long',
          year: 'numeric'
        });
      }
      
      tableRows += `
        <tr>
          <td style="font-weight: bold; background-color: #f8fafc; padding: 10px 15px;">${formatLabel(key)}</td>
          <td style="padding: 10px 15px;">${displayValue || "-"}</td>
        </tr>
      `;
    }
  });
  
  pdfTableBody.innerHTML = tableRows;
  
  return originalAppNo; // Return for filename consistency
}

window.downloadPDF = () => {
  const pdfContent = document.getElementById("pdfContent");
  pdfContent.classList.remove("hidden");
  
  // Get current item from modal
  const appNoElement = document.getElementById("modalApplicationNo");
  const currentAppId = appNoElement.dataset?.appId || '';
  const currentItem = allApplications.find(a => a.id === currentAppId);
  
  if (!currentItem) {
    alert("‡§Ü‡§µ‡•á‡§¶‡§® ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§");
    pdfContent.classList.add("hidden");
    return;
  }
  
  // Regenerate PDF content with proper app number format
  const originalAppNo = preparePDFContent(currentItem, '');
  
  // Wait for QR code to fully render (critical fix)
  setTimeout(() => {
    const element = document.getElementById("pdfContent").firstElementChild;
    
    const opt = {
      margin: [15, 10, 10, 10], // top, right, bottom, left
      filename: `AllInOneMP_Application_${originalAppNo}.pdf`,
      image: { 
        type: 'jpeg', 
        quality: 0.95 
      },
      html2canvas: { 
        scale: 2, 
        useCORS: true,
        letterRendering: true,  // Critical for Hindi text
        allowTaint: true,
        logging: false,
        windowWidth: 1200, // Fixed width for consistent rendering
        windowHeight: 1130,
        scrollY: -window.scrollY // Fix scroll position issue
      },
      jsPDF: { 
        unit: 'mm', 
        format: 'a4', 
        orientation: 'portrait',
        compressPDF: true
      }
    };
    
    // Generate PDF with proper Hindi font handling
    html2pdf()
      .set(opt)
      .from(element)
      .save()
      .then(() => {
        pdfContent.classList.add("hidden");
        alert(`‚úÖ PDF ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§Ø‡§æ!\n‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï: ${originalAppNo}`);
      })
      .catch((error) => {
        console.error("PDF generation error:", error);
        pdfContent.classList.add("hidden");
        alert("PDF ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§ï‡•ã ‡§∞‡•Ä‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§");
      });
  }, 800); // Increased delay to ensure QR renders completely
};

window.printApplication = () => {
  const pdfContent = document.getElementById("pdfContent");
  pdfContent.classList.remove("hidden");
  
  // Wait for QR code to render
  setTimeout(() => {
    window.print();
    
    // Cleanup after printing
    setTimeout(() => {
      pdfContent.classList.add("hidden");
    }, 500);
  }, 300);
};

/* ===== EXPORT TO CSV ===== */
function exportToCSV() {
  // Get currently displayed data
  let data = [...allApplications];
  
  // Apply current filters
  if (currentFilters.search) {
    data = data.filter(app => {
      const name = (app.studentName || app.applicantName || '').toLowerCase();
      const id = (app.memberId || '').toLowerCase();
      return name.includes(currentFilters.search) || id.includes(currentFilters.search);
    });
  }
  
  if (currentFilters.service) {
    data = data.filter(app => {
      const service = getServiceName(app).toLowerCase();
      return service.includes(currentFilters.service);
    });
  }
  
  if (currentFilters.status) {
    data = data.filter(app => app.status === currentFilters.status);
  }
  
  if (data.length === 0) {
    alert("‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§");
    return;
  }
  
  // Create CSV content
  const headers = ['‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï', '‡§®‡§æ‡§Æ', '‡§∏‡•á‡§µ‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞', '‡§∏‡§Æ‡§ó‡•ç‡§∞ ID', '‡§§‡§æ‡§∞‡•Ä‡§ñ', '‡§∏‡•ç‡§•‡§ø‡§§‡§ø', '‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞', '‡§à‡§Æ‡•á‡§≤'];
  let csvContent = '\uFEFF' + headers.join(',') + '\n'; // UTF-8 BOM for Hindi support
  
  data.forEach(app => {
    const appNo = `AIO-${app.id.substring(0, 8).toUpperCase()}`;
    const row = [
      appNo,
      app.studentName || app.applicantName || '-',
      getServiceName(app),
      app.memberId || '-',
      app.createdAt ? formatDate(app.createdAt) : '-',
      app.status === 'complete' ? '‡§™‡•Ç‡§∞‡•ç‡§£' : app.status === 'reject' ? '‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§' : '‡§≤‡§Ç‡§¨‡§ø‡§§',
      app.mobileNumber || '-',
      app.email || '-'
    ].map(field => `"${field}"`).join(',');
    
    csvContent += row + '\n';
  });
  
  // Create download link
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  link.setAttribute("href", url);
  link.setAttribute("download", `AllInOneMP_Applications_${new Date().toISOString().split('T')[0]}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Initialize with empty state hidden
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('emptyState').classList.add('hidden');
});
</script>

</body>
</html>
