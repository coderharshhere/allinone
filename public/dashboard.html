<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AllInOne MP ‚Äì Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans Devanagari', sans-serif; background: #f0f4f8; }
        
        .loading-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: white; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 9999;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #e2e8f0; border-top-color: #3b82f6;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .sidebar {
            width: 260px; position: fixed; left: 0; top: 0; height: 100vh;
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            z-index: 50; overflow-y: auto; transition: 0.3s;
        }
        .main-content { margin-left: 260px; padding: 80px 20px 20px; transition: 0.3s; }
        
        .top-bar {
            position: fixed; top: 0; left: 260px; right: 0; height: 64px;
            background: white; z-index: 40; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: space-between; padding: 0 24px;
        }
        
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .top-bar { left: 0; }
        }
        
        .nav-item {
            padding: 12px 20px; margin: 4px 12px; border-radius: 8px;
            color: white; cursor: pointer; display: flex; align-items: center; gap: 12px;
            transition: 0.2s;
        }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.2); }
        
        .page-section { display: none; animation: fadeIn 0.4s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }
        
        .modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center;
            padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { background: #1e40af; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        .status-badge {
            padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600;
            display: inline-flex; align-items: center; gap: 6px; cursor: pointer;
        }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-processing { background: #dbeafe; color: #1e40af; }
        .status-complete { background: #d1fae5; color: #065f46; }
        .status-reject { background: #fee2e2; color: #991b1b; }
        
        .btn-primary {
            background: #2563eb; color: white; border: none; padding: 10px 20px;
            border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary:hover { background: #1d4ed8; }
        
        .form-control {
            width: 100%; padding: 10px 14px; border: 1px solid #d1d5db;
            border-radius: 8px; font-family: inherit; margin-top: 4px;
        }
        .form-control:focus { outline: none; border-color: #2563eb; ring: 2px solid #bfdbfe; }
        
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: #f8fafc; padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #e2e8f0; }
        .data-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; }
        .data-table tr:hover { background: #f8fafc; }
        
        .auth-error {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            color: white; text-align: center; z-index: 10000;
        }
        .auth-error.active { display: flex; }
        
        @media print {
            .no-print { display: none !important; }
            body * { visibility: hidden; }
            #pdfContent, #pdfContent * { visibility: visible; }
            #pdfContent { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
<base target="_blank">
</head>
<body>

<!-- Loading -->
<div id="loadingScreen" class="loading-screen">
    <div class="spinner"></div>
    <h2 class="text-xl font-bold mt-4 text-gray-800">AllInOne MP</h2>
    <p class="text-gray-600 mt-2">‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</p>
    <p id="connectionStatus" class="text-sm text-blue-600 mt-2">Initializing Firebase...</p>
</div>

<!-- Auth Error -->
<div id="authError" class="auth-error">
    <i class="fas fa-lock text-6xl mb-4"></i>
    <h1 class="text-3xl font-bold mb-2">‡§™‡§π‡•Å‡§Ç‡§ö ‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§</h1>
    <p class="text-lg mb-2">‡§≤‡•â‡§ó‡§ø‡§® ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à</p>
    <p id="errorDetails" class="text-sm opacity-80 mb-6"></p>
    <button onclick="window.location.href='adminlogin.html'" class="bg-white text-blue-900 px-6 py-3 rounded-lg font-bold">
        ‡§≤‡•â‡§ó‡§ø‡§® ‡§™‡§∞ ‡§ú‡§æ‡§è‡§Ç
    </button>
</div>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <div class="p-4 border-b border-blue-700/50 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="bg-white w-10 h-10 rounded-lg flex items-center justify-center font-bold text-blue-900">MP</div>
            <div>
                <h1 class="text-white font-bold">AllInOne-MP</h1>
                <p class="text-blue-200 text-xs">Admin Panel</p>
            </div>
        </div>
        <button onclick="toggleSidebar()" class="text-white lg:hidden"><i class="fas fa-times"></i></button>
    </div>
    
    <nav class="mt-4">
        <div class="nav-item active" onclick="showSection('dashboard')">
            <i class="fas fa-home w-6"></i> <span>‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</span>
        </div>
        <div class="nav-item" onclick="showSection('applications')">
            <i class="fas fa-file-alt w-6"></i> <span>‡§Ü‡§µ‡•á‡§¶‡§®</span>
        </div>
        <div class="nav-item" onclick="showSection('newApplication')">
            <i class="fas fa-plus w-6"></i> <span>‡§®‡§Ø‡§æ ‡§Ü‡§µ‡•á‡§¶‡§®</span>
        </div>
        <div class="nav-item" onclick="showSection('settings')">
            <i class="fas fa-cog w-6"></i> <span>‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏</span>
        </div>
    </nav>
    
    <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-blue-700/50">
        <button onclick="logout()" class="w-full bg-white/10 hover:bg-red-500/20 text-white py-2 rounded-lg flex items-center justify-center gap-2 transition">
            <i class="fas fa-sign-out-alt"></i> <span>‡§≤‡•â‡§ó‡§Ü‡§â‡§ü</span>
        </button>
    </div>
</aside>

<!-- Top Bar -->
<div class="top-bar">
    <div class="flex items-center gap-4">
        <button onclick="toggleSidebar()" class="lg:hidden p-2"><i class="fas fa-bars"></i></button>
        <span id="pageTitle" class="text-lg font-bold text-gray-800">‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</span>
    </div>
    <div class="flex items-center gap-4">
        <div class="text-right hidden md:block">
            <div id="userName" class="font-bold text-gray-800 text-sm">Loading...</div>
            <div id="userEmail" class="text-xs text-gray-500">Loading...</div>
        </div>
        <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold" id="userAvatar">A</div>
    </div>
</div>

<!-- Main Content -->
<main class="main-content" id="mainContent">

<!-- Dashboard -->
<div id="dashboard" class="page-section active">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-gray-500 text-sm">‡§ï‡•Å‡§≤ ‡§Ü‡§µ‡•á‡§¶‡§®</p>
                    <h3 class="text-2xl font-bold" id="statTotal">0</h3>
                </div>
                <i class="fas fa-file-alt text-blue-500 text-xl"></i>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-yellow-500">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-gray-500 text-sm">‡§≤‡§Ç‡§¨‡§ø‡§§</p>
                    <h3 class="text-2xl font-bold" id="statPending">0</h3>
                </div>
                <i class="fas fa-clock text-yellow-500 text-xl"></i>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-gray-500 text-sm">‡§™‡•Ç‡§∞‡•ç‡§£</p>
                    <h3 class="text-2xl font-bold" id="statComplete">0</h3>
                </div>
                <i class="fas fa-check-circle text-green-500 text-xl"></i>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-gray-500 text-sm">‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§</p>
                    <h3 class="text-2xl font-bold" id="statRejected">0</h3>
                </div>
                <i class="fas fa-times-circle text-red-500 text-xl"></i>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm">
        <div class="p-4 border-b flex flex-col md:flex-row justify-between items-center gap-4">
            <h2 class="text-lg font-bold">‡§Ü‡§µ‡•á‡§¶‡§® ‡§∏‡•Ç‡§ö‡•Ä</h2>
            <div class="flex gap-3 w-full md:w-auto">
                <select id="filterStatus" onchange="applyFilter()" class="form-control w-full md:w-40">
                    <option value="">‡§∏‡§≠‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø</option>
                    <option value="pending">‡§≤‡§Ç‡§¨‡§ø‡§§</option>
                    <option value="processing">‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏‡§ø‡§Ç‡§ó</option>
                    <option value="complete">‡§™‡•Ç‡§∞‡•ç‡§£</option>
                    <option value="reject">‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§</option>
                </select>
                <input type="text" id="searchBox" onkeyup="applyFilter()" placeholder="‡§®‡§æ‡§Æ ‡§ñ‡•ã‡§ú‡•á‡§Ç..." class="form-control w-full md:w-64">
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï</th>
                        <th>‡§®‡§æ‡§Æ</th>
                        <th>‡§∏‡•á‡§µ‡§æ</th>
                        <th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</th>
                        <th>‡§§‡§ø‡§•‡§ø</th>
                        <th>‡§∏‡•ç‡§•‡§ø‡§§‡§ø</th>
                        <th>‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="7" class="text-center py-8 text-gray-500">
                            <i class="fas fa-spinner fa-spin mr-2"></i> ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- New Application -->
<div id="newApplication" class="page-section">
    <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-sm p-6">
        <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h2 class="text-xl font-bold">‡§®‡§Ø‡§æ ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç</h2>
            <button onclick="showSection('dashboard')" class="text-gray-600 hover:text-gray-800">
                <i class="fas fa-arrow-left mr-1"></i> ‡§µ‡§æ‡§™‡§∏
            </button>
        </div>
        
        <form id="appForm" onsubmit="submitApplication(event)">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700">‡§Ü‡§µ‡•á‡§¶‡§ï ‡§ï‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ *</label>
                    <input type="text" id="inpName" class="form-control" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡§™‡§ø‡§§‡§æ/‡§™‡§§‡§ø ‡§ï‡§æ ‡§®‡§æ‡§Æ *</label>
                    <input type="text" id="inpFather" class="form-control" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ *</label>
                    <input type="tel" id="inpMobile" class="form-control" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡§Ü‡§ß‡§æ‡§∞ ‡§®‡§Ç‡§¨‡§∞</label>
                    <input type="text" id="inpAadhar" class="form-control">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡§∏‡•á‡§µ‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ *</label>
                    <select id="inpService" class="form-control" required>
                        <option value="">‡§ö‡•Å‡§®‡•á‡§Ç</option>
                        <option value="samagra">‡§∏‡§Æ‡§ó‡•ç‡§∞ ‡§Ü‡§à‡§°‡•Ä</option>
                        <option value="mpbhoj">‡§è‡§Æ‡§™‡•Ä ‡§≠‡•ã‡§ú</option>
                        <option value="scholarship">‡§õ‡§æ‡§§‡•ç‡§∞‡§µ‡•É‡§§‡•ç‡§§‡§ø</option>
                        <option value="pension">‡§™‡•á‡§Ç‡§∂‡§®</option>
                        <option value="housing">‡§Ü‡§µ‡§æ‡§∏</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡§ú‡§ø‡§≤‡§æ *</label>
                    <select id="inpDistrict" class="form-control" required>
                        <option value="">‡§ö‡•Å‡§®‡•á‡§Ç</option>
                        <option value="bhopal">‡§≠‡•ã‡§™‡§æ‡§≤</option>
                        <option value="indore">‡§á‡§Ç‡§¶‡•å‡§∞</option>
                        <option value="jabalpur">‡§ú‡§¨‡§≤‡§™‡•Å‡§∞</option>
                        <option value="gwalior">‡§ó‡•ç‡§µ‡§æ‡§≤‡§ø‡§Ø‡§∞</option>
                        <option value="ujjain">‡§â‡§ú‡•ç‡§ú‡•à‡§®</option>
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700">‡§™‡•Ç‡§∞‡§æ ‡§™‡§§‡§æ *</label>
                    <textarea id="inpAddress" class="form-control" rows="3" required></textarea>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end gap-3">
                <button type="reset" class="px-4 py-2 border rounded-lg hover:bg-gray-50">‡§∞‡•Ä‡§∏‡•á‡§ü</button>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save mr-2"></i> ‡§Ü‡§µ‡•á‡§¶‡§® ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Applications (List View) -->
<div id="applications" class="page-section">
    <div class="bg-white rounded-xl shadow-sm p-6">
        <h2 class="text-xl font-bold mb-4">‡§∏‡§≠‡•Ä ‡§Ü‡§µ‡•á‡§¶‡§®</h2>
        <p>‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§Æ‡•á‡§Ç ‡§π‡§æ‡§≤ ‡§ï‡•á ‡§Ü‡§µ‡•á‡§¶‡§® ‡§¶‡§ø‡§ñ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§</p>
    </div>
</div>

<!-- Settings -->
<div id="settings" class="page-section">
    <div class="bg-white rounded-xl shadow-sm p-6">
        <h2 class="text-xl font-bold mb-4">‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏</h2>
        <div class="space-y-4">
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                <div>
                    <p class="font-medium">‡§°‡§æ‡§∞‡•ç‡§ï ‡§Æ‡•ã‡§°</p>
                    <p class="text-sm text-gray-500">‡§°‡§æ‡§∞‡•ç‡§ï ‡§•‡•Ä‡§Æ ‡§á‡§®‡•á‡§¨‡§≤ ‡§ï‡§∞‡•á‡§Ç</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
        </div>
    </div>
</div>

</main>

<!-- View Modal -->
<div id="viewModal" class="modal">
    <div class="modal-content">
        <div class="modal-header no-print">
            <h3 class="text-xl font-bold"><i class="fas fa-file-invoice mr-2"></i>‡§Ü‡§µ‡•á‡§¶‡§® ‡§µ‡§ø‡§µ‡§∞‡§£</h3>
            <button onclick="closeModal()" class="text-white hover:text-gray-200"><i class="fas fa-times text-xl"></i></button>
        </div>
        
        <div id="pdfContent" class="p-6">
            <div class="text-center mb-6 border-b-2 border-blue-200 pb-4">
                <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center text-white text-2xl font-bold mx-auto mb-3">MP</div>
                <h2 class="text-2xl font-bold text-gray-800">‡§Æ‡§ß‡•ç‡§Ø ‡§™‡•ç‡§∞‡§¶‡•á‡§∂ ‡§∏‡§∞‡§ï‡§æ‡§∞</h2>
                <p class="text-gray-600">AllInOne MP Portal</p>
                <div class="mt-3 inline-block bg-blue-100 text-blue-800 px-4 py-1 rounded-full font-mono font-bold" id="viewAppNo">---</div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <h4 class="font-bold text-gray-800 mb-3 border-b pb-2">‡§Ü‡§µ‡•á‡§¶‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</h4>
                    <div id="viewApplicant" class="space-y-2 text-sm"></div>
                </div>
                <div>
                    <h4 class="font-bold text-gray-800 mb-3 border-b pb-2">‡§Ü‡§µ‡•á‡§¶‡§® ‡§µ‡§ø‡§µ‡§∞‡§£</h4>
                    <div id="viewApplication" class="space-y-2 text-sm"></div>
                </div>
            </div>
        </div>
        
        <div class="p-4 border-t bg-gray-50 flex justify-between no-print">
            <div class="space-x-2">
                <button onclick="changeStatus('processing')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏‡§ø‡§Ç‡§ó</button>
                <button onclick="changeStatus('complete')" class="px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200">‡§™‡•Ç‡§∞‡•ç‡§£</button>
                <button onclick="changeStatus('reject')" class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§</button>
            </div>
            <div class="space-x-2">
                <button onclick="downloadWord()" class="btn-primary text-sm"><i class="fas fa-file-word mr-1"></i> Word</button>
                <button onclick="downloadPDF()" class="btn-primary text-sm bg-gray-700"><i class="fas fa-file-pdf mr-1"></i> PDF</button>
                <button onclick="window.print()" class="btn-primary text-sm bg-gray-600"><i class="fas fa-print mr-1"></i> ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü</button>
            </div>
        </div>
    </div>
</div>

<script>
// ‚úÖ Firebase Configuration - Ab sab sahi hai
const firebaseConfig = {
    apiKey: "AIzaSyA-iZvVroV-H6aRs7X-mlnt_ra3_vnaNzg",
    authDomain: "allinone-mp.firebaseapp.com",
    projectId: "allinone-mp",  // Error mein yahi dikh raha tha
    storageBucket: "allinone-mp.appspot.com",
    messagingSenderId: "1234567890",
    appId: "1:1234567890:web:abcdef123456"
};

// Initialize
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Enable offline persistence (optional but recommended)
db.enablePersistence()
  .catch((err) => {
      if (err.code == 'failed-precondition') {
          console.log("Multiple tabs open, persistence can only be enabled in one tab at a a time.");
      } else if (err.code == 'unimplemented') {
          console.log("Browser doesn't support persistence");
      }
  });

// Global Variables
let allApplications = [];
let currentEditId = null;

// üöÄ Main Initialization
document.addEventListener('DOMContentLoaded', function() {
    console.log("Page loaded, checking auth...");
    
    // Auth State Observer
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            console.log("‚úÖ Auth success:", user.email);
            
            // Update UI
            document.getElementById('userName').textContent = user.displayName || user.email.split('@')[0];
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userAvatar').textContent = (user.displayName || user.email).charAt(0).toUpperCase();
            
            // Hide loading after short delay
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
            }, 1000);
            
            // Load Data
            loadData();
            
        } else {
            console.log("‚ùå Not authenticated");
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('authError').classList.add('active');
            document.getElementById('errorDetails').textContent = "‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç";
        }
    });
});

// üìä Load Data from Firestore
function loadData() {
    document.getElementById('connectionStatus').textContent = "‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...";
    
    // Real-time listener
    db.collection('applications')
        .orderBy('createdAt', 'desc')
        .onSnapshot((snapshot) => {
            console.log("Data received:", snapshot.size);
            
            allApplications = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                createdAt: doc.data().createdAt?.toDate() || new Date()
            }));
            
            renderTable(allApplications);
            updateStats(allApplications);
            
        }, (error) => {
            console.error("Firestore Error:", error);
            document.getElementById('connectionStatus').textContent = "Error: " + error.message;
            
            // Show error in table
            document.getElementById('tableBody').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-circle text-3xl mb-2"></i>
                        <p>‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ</p>
                        <p class="text-sm">${error.message}</p>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded">‡§∞‡•Ä‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç</button>
                    </td>
                </tr>
            `;
        });
}

// üìã Render Table
function renderTable(data) {
    const tbody = document.getElementById('tableBody');
    
    if(data.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-8 text-gray-500">
                    <i class="fas fa-inbox text-3xl mb-2"></i>
                    <p>‡§ï‡•ã‡§à ‡§Ü‡§µ‡•á‡§¶‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</p>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    data.forEach(item => {
        const appNo = item.applicationNumber || `AIO-${item.id.substr(0,6).toUpperCase()}`;
        const date = item.createdAt.toLocaleDateString('hi-IN');
        const status = item.status || 'pending';
        
        const statusClass = {
            'pending': 'status-pending',
            'processing': 'status-processing', 
            'complete': 'status-complete',
            'reject': 'status-reject'
        }[status] || 'status-pending';
        
        const statusText = {
            'pending': '‡§≤‡§Ç‡§¨‡§ø‡§§',
            'processing': '‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏‡§ø‡§Ç‡§ó',
            'complete': '‡§™‡•Ç‡§∞‡•ç‡§£',
            'reject': '‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§'
        }[status] || '‡§≤‡§Ç‡§¨‡§ø‡§§';
        
        html += `
            <tr>
                <td class="font-mono text-sm font-bold text-blue-700">${appNo}</td>
                <td class="font-medium">${item.applicantName || '-'}</td>
                <td><span class="px-2 py-1 bg-blue-50 text-blue-700 rounded text-xs">${getServiceName(item.serviceType)}</span></td>
                <td class="text-sm">${item.mobileNumber || '-'}</td>
                <td class="text-sm text-gray-600">${date}</td>
                <td><span class="status-badge ${statusClass}" onclick="quickStatus('${item.id}', '${status}')">${statusText}</span></td>
                <td>
                    <button onclick="viewDetails('${item.id}')" class="text-blue-600 hover:text-blue-800 mr-2" title="‡§¶‡•á‡§ñ‡•á‡§Ç"><i class="fas fa-eye"></i></button>
                    <button onclick="deleteApp('${item.id}')" class="text-red-600 hover:text-red-800" title="‡§π‡§ü‡§æ‡§è‡§Ç"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// üìä Update Stats
function updateStats(data) {
    document.getElementById('statTotal').textContent = data.length;
    document.getElementById('statPending').textContent = data.filter(a => !a.status || a.status === 'pending').length;
    document.getElementById('statComplete').textContent = data.filter(a => a.status === 'complete').length;
    document.getElementById('statRejected').textContent = data.filter(a => a.status === 'reject').length;
}

// üëÅÔ∏è View Details - FIXED
function viewDetails(id) {
    const item = allApplications.find(a => a.id === id);
    if(!item) return alert("‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ");
    
    currentEditId = id;
    
    const appNo = item.applicationNumber || `AIO-${item.id.substr(0,6).toUpperCase()}`;
    document.getElementById('viewAppNo').textContent = appNo;
    
    // Applicant Details
    document.getElementById('viewApplicant').innerHTML = `
        <div class="flex justify-between border-b py-2"><span class="text-gray-600">‡§®‡§æ‡§Æ:</span> <span class="font-medium">${item.applicantName || '-'}</span></div>
        <div class="flex justify-between border-b py-2"><span class="text-gray-600">‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ:</span> <span class="font-medium">${item.fatherName || '-'}</span></div>
        <div class="flex justify-between border-b py-2"><span class="text-gray-600">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤:</span> <span class="font-medium">${item.mobileNumber || '-'}</span></div>
        <div class="flex justify-between border-b py-2"><span class="text-gray-600">‡§Ü‡§ß‡§æ‡§∞:</span> <span class="font-medium">${maskAadhar(item.aadharNumber)}</span></div>
        <div class="flex justify-between border-b py-2"><span class="text-gray-600">‡§™‡§§‡§æ:</span> <span class="font-medium">${item.address || '-'}</span></div>
    `;
    
    // Application Details
    document.getElementById('viewApplication').innerHTML = `
        <div class="flex justify-between border-b py-2"><span class="text-gray-600">‡§∏‡•á‡§µ‡§æ:</span> <span class="font-medium">${getServiceName(item.serviceType)}</span></div>
        <div class="flex justify-between border-b py-2"><span class="text-gray-600">‡§ú‡§ø‡§≤‡§æ:</span> <span class="font-medium">${getDistrictName(item.district)}</span></div>
        <div class="flex justify-between border-b py-2"><span class="text-gray-600">‡§§‡§ø‡§•‡§ø:</span> <span class="font-medium">${item.createdAt.toLocaleDateString('hi-IN')}</span></div>
        <div class="flex justify-between border-b py-2"><span class="text-gray-600">‡§∏‡•ç‡§•‡§ø‡§§‡§ø:</span> <span class="font-medium text-${item.status === 'complete' ? 'green' : item.status === 'reject' ? 'red' : 'yellow'}-600">${item.status === 'complete' ? '‡§™‡•Ç‡§∞‡•ç‡§£' : item.status === 'reject' ? '‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§' : item.status === 'processing' ? '‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏‡§ø‡§Ç‡§ó' : '‡§≤‡§Ç‡§¨‡§ø‡§§'}</span></div>
    `;
    
    document.getElementById('viewModal').classList.add('active');
}

// üíæ Submit Application
async function submitApplication(e) {
    e.preventDefault();
    
    const data = {
        applicantName: document.getElementById('inpName').value,
        fatherName: document.getElementById('inpFather').value,
        mobileNumber: document.getElementById('inpMobile').value,
        aadharNumber: document.getElementById('inpAadhar').value,
        serviceType: document.getElementById('inpService').value,
        district: document.getElementById('inpDistrict').value,
        address: document.getElementById('inpAddress').value,
        status: 'pending',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    try {
        await db.collection('applications').add(data);
        alert('‚úÖ ‡§Ü‡§µ‡•á‡§¶‡§® ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ!');
        document.getElementById('appForm').reset();
        showSection('dashboard');
    } catch(err) {
        alert('‚ùå ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + err.message);
    }
}

// üîÑ Quick Status Change
async function quickStatus(id, current) {
    const statuses = ['pending', 'processing', 'complete', 'reject'];
    const next = statuses[(statuses.indexOf(current) + 1) % 4];
    
    try {
        await db.collection('applications').doc(id).update({
            status: next,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch(err) {
        alert('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + err.message);
    }
}

// üîÑ Change Status from Modal
async function changeStatus(status) {
    if(!currentEditId) return;
    try {
        await db.collection('applications').doc(currentEditId).update({
            status: status,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert('‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§à');
        closeModal();
    } catch(err) {
        alert('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + err.message);
    }
}

// üóëÔ∏è Delete
async function deleteApp(id) {
    if(!confirm('‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?')) return;
    try {
        await db.collection('applications').doc(id).delete();
        alert('‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ');
    } catch(err) {
        alert('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + err.message);
    }
}

// üìÑ Download Word - FIXED
function downloadWord() {
    if(!currentEditId) return alert("‡§ï‡•ã‡§à ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ö‡§Ø‡§®‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç");
    
    const item = allApplications.find(a => a.id === currentEditId);
    const appNo = item.applicationNumber || `AIO-${item.id.substr(0,6).toUpperCase()}`;
    
    const html = `
    <html xmlns:o='urn:schemas-microsoft-com:office:office'>
    <head><meta charset='utf-8'><title>Receipt</title></head>
    <body style="font-family: Arial; padding: 40px;">
        <h1 style="color: #1e40af; text-align: center;">‡§Æ‡§ß‡•ç‡§Ø ‡§™‡•ç‡§∞‡§¶‡•á‡§∂ ‡§∏‡§∞‡§ï‡§æ‡§∞</h1>
        <h2 style="text-align: center;">AllInOne MP Portal</h2>
        <hr style="margin: 20px 0;">
        
        <table style="width: 100%; border-collapse: collapse;">
            <tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï:</td><td style="padding: 8px; border: 1px solid #ddd;">${appNo}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">‡§Ü‡§µ‡•á‡§¶‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ:</td><td style="padding: 8px; border: 1px solid #ddd;">${item.applicantName || '-'}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ:</td><td style="padding: 8px; border: 1px solid #ddd;">${item.fatherName || '-'}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤:</td><td style="padding: 8px; border: 1px solid #ddd;">${item.mobileNumber || '-'}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">‡§∏‡•á‡§µ‡§æ:</td><td style="padding: 8px; border: 1px solid #ddd;">${getServiceName(item.serviceType)}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">‡§ú‡§ø‡§≤‡§æ:</td><td style="padding: 8px; border: 1px solid #ddd;">${getDistrictName(item.district)}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">‡§™‡§§‡§æ:</td><td style="padding: 8px; border: 1px solid #ddd;">${item.address || '-'}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">‡§∏‡•ç‡§•‡§ø‡§§‡§ø:</td><td style="padding: 8px; border: 1px solid #ddd;">${item.status === 'complete' ? '‡§™‡•Ç‡§∞‡•ç‡§£' : item.status === 'reject' ? '‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§' : '‡§≤‡§Ç‡§¨‡§ø‡§§'}</td></tr>
        </table>
        
        <p style="margin-top: 40px; text-align: center; color: #666; font-size: 12px;">
            ‡§Ø‡§π ‡§ï‡§Ç‡§™‡•ç‡§Ø‡•Ç‡§ü‡§∞ ‡§ú‡§®‡§∞‡•á‡§ü‡•á‡§° ‡§∞‡§∏‡•Ä‡§¶ ‡§π‡•à‡•§<br>
            https://allinonemp.harshtiwari.in
        </p>
    </body>
    </html>`;
    
    const blob = new Blob(['\ufeff', html], {type: 'application/msword'});
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `Receipt_${appNo}.doc`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// üìÑ Download PDF
function downloadPDF() {
    const element = document.getElementById('pdfContent');
    if(!element) return;
    
    html2pdf().from(element).set({
        margin: 0.5,
        filename: 'application_receipt.pdf',
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    }).save();
}

// Filter
function applyFilter() {
    const status = document.getElementById('filterStatus').value;
    const search = document.getElementById('searchBox').value.toLowerCase();
    
    let filtered = allApplications;
    if(status) filtered = filtered.filter(a => (a.status || 'pending') === status);
    if(search) filtered = filtered.filter(a => (a.applicantName || '').toLowerCase().includes(search));
    
    renderTable(filtered);
}

// Navigation
function showSection(id) {
    document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    event.target.closest('.nav-item').classList.add('active');
    
    const titles = {
        'dashboard': '‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°',
        'applications': '‡§Ü‡§µ‡•á‡§¶‡§® ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®',
        'newApplication': '‡§®‡§Ø‡§æ ‡§Ü‡§µ‡•á‡§¶‡§®',
        'settings': '‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏'
    };
    document.getElementById('pageTitle').textContent = titles[id] || '‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°';
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('active');
}

function closeModal() {
    document.getElementById('viewModal').classList.remove('active');
}

function logout() {
    auth.signOut().then(() => location.href = 'adminlogin.html');
}

// Helpers
function getServiceName(type) {
    const map = {samagra: '‡§∏‡§Æ‡§ó‡•ç‡§∞', mpbhoj: '‡§≠‡•ã‡§ú', scholarship: '‡§õ‡§æ‡§§‡•ç‡§∞‡§µ‡•É‡§§‡•ç‡§§‡§ø', pension: '‡§™‡•á‡§Ç‡§∂‡§®', housing: '‡§Ü‡§µ‡§æ‡§∏'};
    return map[type] || type;
}
function getDistrictName(d) {
    const map = {bhopal: '‡§≠‡•ã‡§™‡§æ‡§≤', indore: '‡§á‡§Ç‡§¶‡•å‡§∞', jabalpur: '‡§ú‡§¨‡§≤‡§™‡•Å‡§∞', gwalior: '‡§ó‡•ç‡§µ‡§æ‡§≤‡§ø‡§Ø‡§∞', ujjain: '‡§â‡§ú‡•ç‡§ú‡•à‡§®'};
    return map[d] || d;
}
function maskAadhar(a) {
    return a ? a.toString().replace(/.(?=.{4})/g, 'X') : '-';
}
</script>

</body>
</html>
