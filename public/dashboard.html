<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AllInOne MP ‚Äì Dashboard</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap');
        body { font-family: 'Noto Sans Devanagari', sans-serif; }
        .ticker-wrapper { overflow: hidden; background: #fffbeb; }
        .ticker-text {
            display: inline-block;
            white-space: nowrap;
            padding-left: 100%;
            animation: ticker 30s linear infinite;
        }
        @keyframes ticker {
            100% { transform: translateX(-100%); }
        }
        .active-filter {
            border: 2px solid #1e40af !important;
            font-weight: bold;
        }
    </style>
</head>

<body class="bg-gray-100 flex flex-col min-h-screen">

<!-- ================= TOP BAR ================= -->
<div class="bg-blue-900 text-white text-[10px] md:text-xs py-2 px-4 flex justify-between items-center">
    <div>‡§Æ‡§ß‡•ç‡§Ø‡§™‡•ç‡§∞‡§¶‡•á‡§∂ ‡§∏‡§∞‡§ï‡§æ‡§∞ | Government of Madhya Pradesh</div>
    <div class="flex gap-4">
        <a href="#" class="hover:underline hidden md:block">Screen Reader Access</a>
        <span>A- | A | A+</span>
    </div>
</div>

<!-- ================= HEADER ================= -->
<header class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Emblem_of_Madhya_Pradesh.svg/1200px-Emblem_of_Madhya_Pradesh.svg.png"
                 class="h-10 md:h-14" alt="MP Logo">
            <div>
                <h1 class="text-xl md:text-2xl font-bold text-blue-900">AllInOne MP</h1>
                <p class="text-[10px] md:text-sm text-gray-600">‡§µ‡§® ‡§µ‡§ø‡§Ç‡§°‡•ã ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤</p>
            </div>
        </div>

        <div class="flex gap-4 items-center">
            <div class="hidden lg:text-right lg:block">
                <p class="text-xs text-gray-500 uppercase">‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞</p>
                <p class="font-bold text-blue-800">8435273042</p>
            </div>
            <button onclick="handleLogout()"
                class="bg-red-600 text-white px-4 py-1.5 md:px-6 md:py-2 rounded-full text-sm font-bold hover:bg-red-700 transition">
                ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü
            </button>
        </div>
    </div>
</header>

<!-- ================= NAV ================= -->
<nav class="bg-blue-800 text-white overflow-x-auto">
    <div class="container mx-auto px-4">
        <ul class="flex whitespace-nowrap py-3 gap-6 md:gap-8 text-sm">
            <li><a href="#" class="hover:text-blue-200 flex items-center gap-2">
                <i class="fas fa-home"></i> ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§™‡•É‡§∑‡•ç‡§†</a></li>
            <li><a href="#" class="hover:text-blue-200">‡§®‡§æ‡§ó‡§∞‡§ø‡§ï ‡§∏‡•á‡§µ‡§æ‡§è‡§Å</a></li>
            <li><a href="#" class="hover:text-blue-200">‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Å</a></li>
            <li><a href="#" class="text-yellow-400 font-bold">‡§µ‡§ø‡§≠‡§æ‡§ó‡•Ä‡§Ø ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</a></li>
            <li><a href="#" class="hover:text-blue-200">‡§∂‡§ø‡§ï‡§æ‡§Ø‡§§ ‡§®‡§ø‡§µ‡§æ‡§∞‡§£</a></li>
        </ul>
    </div>
</nav>

<!-- ================= TICKER ================= -->
<div class="ticker-wrapper py-2 border-b border-amber-100">
    <div class="ticker-text text-sm text-red-600 font-bold">
        üì¢ ‡§∏‡•Ç‡§ö‡§®‡§æ: ‡§≤‡§æ‡§°‡§º‡§≤‡•Ä ‡§¨‡§π‡§®‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§ï‡•á ‡§Ö‡§Ç‡§§‡§∞‡•ç‡§ó‡§§ ‡§ï‡•á‡§µ‡§æ‡§à‡§∏‡•Ä ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø | ‡§Æ‡•Å‡§ñ‡•ç‡§Ø‡§Æ‡§Ç‡§§‡•ç‡§∞‡•Ä ‡§∏‡•Ä‡§ñ‡•ã-‡§ï‡§Æ‡§æ‡§ì ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠ | ‡§∏‡§Æ‡§ó‡•ç‡§∞ ‡§Ü‡§à‡§°‡•Ä ‡§Æ‡•á‡§Ç ‡§Ü‡§ß‡§æ‡§∞ ‡§≤‡§ø‡§Ç‡§ï ‡§®‡§ø‡§É‡§∂‡•Å‡§≤‡•ç‡§ï | ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§Ö‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡•á‡§≤‡•ç‡§™‡§≤‡§æ‡§á‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§™‡§∞ ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç |
    </div>
</div>

<!-- ================= MAIN ================= -->
<main class="flex-grow container mx-auto px-4 py-6 md:py-10">

    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <h2 class="text-xl md:text-2xl font-bold text-gray-800">
            <i class="fas fa-list-check mr-2 text-blue-600"></i> ‡§Ü‡§µ‡•á‡§¶‡§® ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°
        </h2>
        
        <!-- SEARCH -->
        <div class="relative w-full md:w-64">
            <input type="text" id="searchInput" placeholder="‡§®‡§æ‡§Æ ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç..." 
                   class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
        </div>
    </div>

    <!-- FILTER TABS -->
    <div class="flex flex-wrap gap-2 mb-8" id="filterButtons">
        <button onclick="filterByType('ALL')" id="btn-ALL" class="px-5 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm transition active-filter">
            ‡§∏‡§≠‡•Ä (All)
        </button>
        <button onclick="filterByType('samagra')" id="btn-samagra" class="px-5 py-2 bg-blue-100 hover:bg-blue-200 rounded-lg text-sm transition">
            ‡§∏‡§Æ‡§ó‡•ç‡§∞ (Samagra)
        </button>
        <button onclick="filterByType('nivas')" id="btn-nivas" class="px-5 py-2 bg-green-100 hover:bg-green-200 rounded-lg text-sm transition">
            ‡§®‡§ø‡§µ‡§æ‡§∏ (Nivas)
        </button>
        <button onclick="filterByType('jati')" id="btn-jati" class="px-5 py-2 bg-yellow-100 hover:bg-yellow-200 rounded-lg text-sm transition">
            ‡§ú‡§æ‡§§‡§ø (Jati)
        </button>
    </div>

    <!-- DATA STATUS MESSAGE -->
    <div id="loadingStatus" class="text-center py-10 text-gray-600 bg-white rounded-xl shadow-sm border border-dashed border-gray-300">
        <div id="loadingContent">
            <i class="fas fa-spinner fa-spin mr-2 text-blue-600"></i> ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç...
        </div>
    </div>

    <!-- TABLE -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden hidden" id="tableContainer">
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead class="bg-blue-900 text-white">
                    <tr>
                        <th class="px-6 py-4 text-left font-medium">‡§Ü‡§µ‡•á‡§¶‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ</th>
                        <th class="px-6 py-4 text-left font-medium">‡§∏‡•á‡§µ‡§æ ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</th>
                        <th class="px-6 py-4 text-left font-medium">‡§∏‡§Æ‡§ó‡•ç‡§∞ ID / ‡§Ü‡§ß‡§æ‡§∞</th>
                        <th class="px-6 py-4 text-left font-medium">‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø</th>
                    </tr>
                </thead>
                <tbody id="dataTable" class="divide-y divide-gray-200">
                    <!-- Firebase Data Injection -->
                </tbody>
            </table>
        </div>
        <div id="noDataMsg" class="hidden p-10 text-center text-gray-500">
            <i class="fas fa-folder-open text-4xl mb-3 block opacity-20"></i>
            ‡§ï‡•ã‡§à ‡§Ü‡§µ‡•á‡§¶‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§
        </div>
    </div>

</main>

<!-- ================= FOOTER ================= -->
<footer class="bg-gray-900 text-gray-400 py-10 px-4 mt-auto">
    <div class="container mx-auto text-center">
        <p>¬© 2026 AllInOne | MP Govt Services Portal</p>
        <p class="text-xs mt-2 text-gray-500">Managed by IT Cell, Madhya Pradesh.</p>
    </div>
</footer>

<!-- ================= DETAIL MODAL ================= -->
<div id="detailModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[100] p-4">
    <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
        <div class="bg-blue-800 text-white px-6 py-4 flex justify-between items-center">
            <h3 class="font-bold text-lg">‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡§æ ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§µ‡§ø‡§µ‡§∞‡§£</h3>
            <button onclick="closeDetails()" class="text-2xl font-bold leading-none hover:text-red-200">√ó</button>
        </div>
        <div id="detailBody" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-8 text-sm max-h-[70vh] overflow-y-auto">
            <!-- Details Injection -->
        </div>
        <div class="bg-gray-50 px-6 py-4 border-t flex justify-end">
            <button onclick="closeDetails()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700">‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
        </div>
    </div>
</div>

<!-- ================= FIREBASE & LOGIC ================= -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let allApplications = [];
    let currentUser = null;

    const firebaseConfig = {
  apiKey: "AIzaSyA-iZvVroV-H6aRs7X-mlnt_ra3_vnaNzg",
  authDomain: "allinone-aa89.firebaseapp.com",
  projectId: "allinone-aa89"
};


    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    async function initAuth() {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Auth error:", error);
            document.getElementById("loadingContent").innerHTML = 
                `<span class="text-red-500 font-bold"><i class="fas fa-exclamation-triangle mr-2"></i> ‡§≤‡•â‡§ó‡§ø‡§® ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ: ${error.message}</span>`;
        }
    }

    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (user) {
            startListening();
        }
    });

    window.handleLogout = async () => {
        try {
            await signOut(auth);
            location.reload();
        } catch (e) { console.error(e); }
    };

    function startListening() {
            const colRef = collection(db, "applications");
        
        onSnapshot(colRef, (snapshot) => {
            allApplications = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            // SORTING: Latest First
            allApplications.sort((a, b) => {
                const timeA = a.timestamp || 0;
                const timeB = b.timestamp || 0;
                if (timeA === 0 && timeB === 0) return b.id.localeCompare(a.id);
                return timeB - timeA;
            });

            // UI UPDATES
            document.getElementById("loadingStatus").classList.add("hidden");
            document.getElementById("tableContainer").classList.remove("hidden");
            renderTable(allApplications);
        }, (error) => {
            console.error("Firestore error:", error);
            document.getElementById("loadingContent").innerHTML = 
                `<span class="text-red-500 font-bold"><i class="fas fa-lock mr-2"></i> ‡§°‡•á‡§ü‡§æ ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§Ø‡§æ ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</span>`;
        });
    }

    function renderTable(data) {
        const tableBody = document.getElementById("dataTable");
        const noData = document.getElementById("noDataMsg");
        tableBody.innerHTML = "";

        if (data.length === 0) {
            noData.classList.remove("hidden");
            return;
        }

        noData.classList.add("hidden");

        data.forEach(item => {
            const statusColor = item.status === 'complete' ? 'text-green-600' : 
                                item.status === 'reject' ? 'text-red-600' : 'text-blue-600';

            const row = document.createElement("tr");
            row.className = "hover:bg-blue-50 transition border-b";
            row.innerHTML = `
                <td class="px-6 py-4">
                    <button onclick="openDetails('${item.id}')" class="text-blue-700 font-bold hover:underline text-left">
                        ${item.applicantName || "‡§Ö‡§ú‡•ç‡§û‡§æ‡§§"}
                    </button>
                    <div class="text-[10px] text-gray-400">ID: ${item.id.substring(0,8)}</div>
                </td>
                <td class="px-6 py-4 capitalize font-medium text-gray-700">
                    <span class="px-2 py-1 rounded bg-gray-100">${item.serviceType || "-"}</span>
                </td>
                <td class="px-6 py-4 text-gray-600">
                    <div class="text-xs">S: ${item.samagraId || "-"}</div>
                    <div class="text-xs">A: ${item.aadhaar || "-"}</div>
                </td>
                <td class="px-6 py-4">
                    <select onchange="updateApplicationStatus('${item.id}', this.value)" 
                            class="border rounded-md px-2 py-1 font-bold text-xs ${statusColor} outline-none focus:ring-1 focus:ring-blue-400">
                        <option value="pending" ${item.status === 'pending' ? 'selected' : ''}>‚è≥ Pending</option>
                        <option value="complete" ${item.status === 'complete' ? 'selected' : ''}>‚úÖ Complete</option>
                        <option value="reject" ${item.status === 'reject' ? 'selected' : ''}>‚ùå Reject</option>
                    </select>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    window.filterByType = (type) => {
        const btns = document.querySelectorAll("#filterButtons button");
        btns.forEach(b => b.classList.remove("active-filter"));
        document.getElementById(`btn-${type}`).classList.add("active-filter");

        if (type === 'ALL') {
            renderTable(allApplications);
        } else {
            const filtered = allApplications.filter(app => 
                (app.serviceType || "").toLowerCase() === type.toLowerCase()
            );
            renderTable(filtered);
        }
    };

    window.updateApplicationStatus = async (docId, newStatus) => {
        if (!currentUser) return;
        try {
            const docRef = doc(db, "applications", docId);
            await updateDoc(docRef, { status: newStatus });
        } catch (e) {
            console.error("Update error:", e);
        }
    };

    window.openDetails = (id) => {
        const item = allApplications.find(a => a.id === id);
        if (!item) return;

        const detailBody = document.getElementById("detailBody");
        detailBody.innerHTML = `
            <div class="flex flex-col"><span class="text-gray-500 text-xs">‡§®‡§æ‡§Æ</span><span class="font-bold text-base">${item.applicantName || "N/A"}</span></div>
            <div class="flex flex-col"><span class="text-gray-500 text-xs">‡§™‡§ø‡§§‡§æ/‡§™‡§§‡§ø</span><span class="font-bold text-base">${item.fatherName || "N/A"}</span></div>
            <div class="flex flex-col"><span class="text-gray-500 text-xs">‡§∏‡•á‡§µ‡§æ</span><span class="font-bold text-blue-700 capitalize text-base">${item.serviceType || "N/A"}</span></div>
            <div class="flex flex-col"><span class="text-gray-500 text-xs">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</span><span class="font-bold text-base">${item.mobile || "N/A"}</span></div>
            <div class="flex flex-col"><span class="text-gray-500 text-xs">‡§∏‡§Æ‡§ó‡•ç‡§∞ ‡§Ü‡§à‡§°‡•Ä</span><span class="font-bold text-base">${item.samagraId || "N/A"}</span></div>
            <div class="flex flex-col"><span class="text-gray-500 text-xs">‡§Ü‡§ß‡§æ‡§∞</span><span class="font-bold text-base">${item.aadhaar || "N/A"}</span></div>
            <div class="flex flex-col"><span class="text-gray-500 text-xs">‡§Ü‡§Ø</span><span class="font-bold text-green-700 text-base">‚Çπ ${item.annualIncome || "0"}</span></div>
            <div class="flex flex-col"><span class="text-gray-500 text-xs">‡§∏‡•ç‡§•‡§ø‡§§‡§ø</span><span class="font-bold uppercase text-base">${item.status || "pending"}</span></div>
            <div class="flex flex-col md:col-span-2 bg-blue-50 p-4 rounded-xl border border-blue-100 mt-2">
                <span class="text-blue-600 text-xs font-bold uppercase mb-1">‡§™‡•Ç‡§∞‡§æ ‡§™‡§§‡§æ</span>
                <span class="text-gray-700 leading-relaxed">${item.fullAddress || "‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à"}</span>
            </div>
        `;

        document.getElementById("detailModal").classList.remove("hidden");
        document.getElementById("detailModal").classList.add("flex");
    };

    window.closeDetails = () => {
        document.getElementById("detailModal").classList.add("hidden");
        document.getElementById("detailModal").classList.remove("flex");
    };

    // SEARCH LOGIC
    document.getElementById("searchInput").addEventListener("input", (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = allApplications.filter(app => 
            (app.applicantName || "").toLowerCase().includes(term) ||
            (app.samagraId || "").toLowerCase().includes(term)
        );
        renderTable(filtered);
    });

    initAuth();
</script>
    
</body>
</html>
